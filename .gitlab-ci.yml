stages:
  - build
  - build_noora

variables:
  GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_COMMIT_REF_SLUG

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - externallibs/

build:
  stage: build

  script:
    ./buildFromScratch.sh astra_trunk/trunk

  variables:
    ENABLE_ORACLE: "1"

  artifacts:
    name: "tclmonlog"
    paths:
      - src/tclmon.log
    when: on_failure

build_noora:
  stage: build

  variables:
    DOCKERFILE: "./Dockerfile"

  before_script:
   - export CONTAINER_IMAGE="$CI_REGISTRY_IMAGE:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
   - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

  script:
    - docker build -t "${CONTAINER_IMAGE}" -f "${DOCKERFILE}" .
    - docker run --rm "${CONTAINER_IMAGE}" ./buildFromScratch.sh conn/string --runtests
    - docker push "${CONTAINER_IMAGE}"

  artifacts:
    name: "tclmonlog"
    paths:
      - src/tclmon.log
    when: on_failure
